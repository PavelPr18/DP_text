\chapter{Návrh SW řešení pro komunikaci pomocí optimalizovaného protokolu}	\label{sw}
Pro komunikaci s HW řešením navrženým v kapitole \ref{jtag_ap} bylo třeba rozšířit testovací software v PC o podporu komunikace pomocí optimalizovaného protokolu. Tato kapitola se zabývá tvorbou softwarových funkcí, které může debugger použít pro přístup na systémovou sběrnici procesoru v čipu. Tyto funkce mohou být použity namísto komunikace pomocí již existujících funkcí využívajících stávajícího systému pro testování popsaného v kapitole \ref{sec:risc-v_dbg}.


\section{Blokové schéma komunikace PC s \acs{FPGA}}
Pro spojení čipu s testovacím software v PC byla využita dodaná vývojová deska. Pro účely testování je možné na desce osadit výměnné moduly obsahující již vyrobený integrovaný obvod nebo obvod \acs{FPGA}. V případě testování funkčnosti navrženého řešení, představeného v kapitolách \ref{jtag_2w} a \ref{jtag_ap}, je na vývojové desce osazen modul TE0725 od firmy \textit{Trenz electronic}, osazený FPGA obvodem AMD Artix™ 7 XC7A100T. Pro převod USB rozhraní na \acs{JTAG} protokol je na vývojové desce osazen převodník \textit{FT4232H} od výrobce FTDI nebo je možné využít programovacího kabelu \textit{HS2} od společnosti \textit{Digilent}, který se používá také k nahrávání \acs{FPGA} obvodu. Obě možnosti spojení \acs{FPGA} s PC jsou naznačeny na obrázku \ref{fig:block_diag}, přičemž výběr způsobu komunikace je umožněn přepnutím přepínačů na desce. Signály \acs{JTAG} rozhraní mohou být připojeny do FPGA modulu na příslušné piny uvedené v tabulce \ref{tab:jtag_dev_board}. Toto propojení signálů odpovídá dané konfiguraci nahrané v FPGA. \cite{TE0725_TRM}  \cite{TE0725_sch} \cite{FTDI4232H} \cite{HS2}

\begin{figure}[H]
  \begin{center}
    \includegraphics[scale=0.9]{obrazky/block_diagram_v2.pdf}
  \end{center}
  \caption{Blokové schéma spojení \acs{JTAG} systému s debuggerem}
	\label{fig:block_diag}
\end{figure}

\begin{table}[H]
  \caption{Tabulka propojení \acs{JTAG} signálů \cite{TE0725_sch} \cite{FTDI4232H} \cite{HS2}}
  \begin{center}
  	\small
	  \begin{tabular}{!{\vrule width 1.2pt}c|c|c|c|c!{\vrule width 1.2pt}}
	    \noalign{\hrule height 1.2pt}
	    Signál & FTDI pin & HS2 pin & TE0725 pin & FPGA pin\\
	    \noalign{\hrule height 1.2pt}
			\texttt{\acs{TCK}} & BDBUS0 (22) & \acs{TCK} & J1 - 42 & E7\\
			\hline
			\texttt{\acs{TMS}} & BDBUS3 (25) & \acs{TMS} & J1 - 48 & D8\\
			\hline
			\texttt{\acs{TDI}} & BDBUS1 (24) & \acs{TDI} & J1 - 47 & C7\\
			\hline
			\texttt{\acs{TDO}} & BDBUS2 (23) & \acs{TDO} & J1 - 44 & F6\\
			\hline
			\noalign{\hrule height 1.2pt}
		\end{tabular}
  \end{center}
	\label{tab:jtag_dev_board}
\end{table}

%\section{Využití OpenOCD ke komunikaci pomocí dvouvodičového \acs{JTAG} protokolu}

\section{FTDI převodník FT4232H}	\label{sec:ft4232h}
Převodník FT4232H disponuje 4 kanály, které umožňují komunikaci s různými sériovými sběrnicemi jako je například UART, SPI, I\textsuperscript{2}C a \acs{JTAG}. Komunikace pomocí \acs{JTAG} rozhraní je realizována prostřednictvím víceúčelového generátoru sériových rozhraní \acs{MPSSE} (\textit{\acl{MPSSE}}), jehož využití je možné na kanálech A a B. Signály \acs{JTAG} rozhraní jsou na vývojové desce připojeny na kanál B dle tabulky \ref{tab:jtag_dev_board}. \cite{FTDI4232H}

\subsection{Příkazy víceúčelového sériového generátoru \acs{MPSSE}}
Víceúčelový generátor sériových rozhraní \acs{MPSSE} je řízen pomocí zápisu definovaných příkazů prostřednictvím USB. Příkazy pro \acs{MPSSE} jsou kódovány jako jeden bajt a každý bit má definovaný význam, jenž je uvedený v tabulce \ref{tab:mpsse_cmd}. \cite{MPSSE_cmd}

\begin{table}[H]
  \caption{Definice příkazů pro \acs{MPSSE} \cite{MPSSE_cmd}}
  \begin{center}
  	\small
	  \begin{tabular}{!{\vrule width 1.2pt}c|c!{\vrule width 1.2pt}}
	    \noalign{\hrule height 1.2pt}
	    Bit & Význam\\
	    \noalign{\hrule height 1.2pt}
			\multirow{2}{*}{0} & log. \texttt{0} = data na \texttt{\acs{TDI}}/\texttt{\acs{TMS}} pinu jsou vystavena na nástupnou hranu \texttt{\acs{TCK}}\\
			%\cline{2-2}
			& log. \texttt{1} = data na \texttt{\acs{TDI}}/\texttt{\acs{TMS}} pinu jsou vystavena na sestupnou hranu \texttt{\acs{TCK}}\\
			\hline
			\multirow{2}{*}{1} & log. \texttt{0} = režim odesílání a přijímání dat po bajtech\\
			& log. \texttt{1} = režim odesílání a přijímání dat po bitech\\
			\hline
			\multirow{2}{*}{2} & log. \texttt{0} = data na \texttt{\acs{TDO}} pinu jsou vzorkována na nástupnou hranu \texttt{\acs{TCK}}\\
			& log. \texttt{1} = data na \texttt{\acs{TDO}} pinu jsou vzorkována na sestupnou hranu \texttt{\acs{TCK}}\\
			\hline
			\multirow{2}{*}{3} & log. \texttt{0} = data jsou přenášena od \acs{MSB}\\
			& log. \texttt{1} = data jsou přenášena od \acs{LSB}\\
			\hline
			4 & aktivace zápisu dat na \texttt{\acs{TDI}} pin\\
			\hline
			5 & aktivace čtení dat z \texttt{\acs{TDO}} pinu\\
			\hline
			6 & aktivace zápisu dat na \texttt{\acs{TMS}} pin\\
			\hline
			7 & vždy log. \texttt{0}\\
			\hline
			\noalign{\hrule height 1.2pt}
		\end{tabular}
  \end{center}
	\label{tab:mpsse_cmd}
\end{table}

Pro \acs{JTAG} komunikaci je třeba využít příkazů, které vždy mají tyto vlastnosti: 
\begin{itemize}[leftmargin = 2cm]
	\item odesílají data od \acs{LSB} (bit 3 = log. \texttt{1}).
	\item data na \texttt{\acs{TDI}} a \texttt{\acs{TMS}} pinu se vystavují na sestupnou hranu (bit 0 = log. \texttt{1}).
	\item data na \texttt{\acs{TDO}} se vzorkují na nástupnou hranu (bit 2 = log. \texttt{0}).
\end{itemize}

\subsubsection{Formát příkazu \acs{MPSSE}}
Struktura příkazů pro \acs{MPSSE} generátor a délka jednotlivých částí v bajtech je uvedena v tabulce \ref{tab:mpsse_cmd_format}. První bajt příkazu vždy obsahuje vlastní kód příkazu podle významu uvedeného v tabulce \ref{tab:mpsse_cmd}. Následující bajt uvádí počet taktů \texttt{\acs{TCK}} hodinového signálu, které chceme vygenerovat což odpovídá délce přenesených dat. V případě, že se jedná o příkaz v režimu přenosu po bajtech (bit 1 kódu příkazu nese hodnotu log. \texttt{0}), je délka určena dvěma bajty a výsledné číslo udává počet přenášených bajtů. Maximální počet dat přenesených v rámci jednoho příkazu je tedy \(2^{16} = 65536\) bajtů. Poslední částí struktury příkazu jsou přenášená data dle zvolené délky v případě, že se jedná o příkaz generující zápis.

\begin{table}[!h]
  \caption{Formát příkazů \acs{MPSSE} \cite{MPSSE_cmd}}
  \begin{center}
  	\small
	  \begin{tabular}{!{\vrule width 1.2pt}c|c!{\vrule width 1.2pt}}
	    \noalign{\hrule height 1.2pt}
	    Část příkazu & Počet bajtů\\
	    \noalign{\hrule height 1.2pt}
			\textit{cmd} & 1\\
			\hline
			\textit{length} & 1 nebo 2\\
			\hline
			\texttt{\acs{TDI}}/\texttt{\acs{TMS}} data & 1 až 65536\\
			\hline
			\noalign{\hrule height 1.2pt}
		\end{tabular}
  \end{center}
	\label{tab:mpsse_cmd_format}
\end{table}

\section{Návrh funkcí pro komunikaci pomocí optimalizovaného protokolu}
Dodaný testovací SW využívaný pro komunikaci s čipem prostřednictvím převodníku FT4232H uvedeného v podkapitole \ref{sec:ft4232h} je realizován v jazyce \textit{Python}, proto i rozšiřující funkce pro komunikaci optimalizovaným protokolem byly vyvíjeny v tomto jazyce. Jako nízkoúrovňová knihovna pro odesílání příkazů do FT4232H převodníku je využita knihovna \textit{PyFtdi}.	\cite{PyFtdi} \cite{PyFtdi_doc}

\subsection{Zápis příkazů pro \acs{MPSSE} do bufferu FTDI převodníku}
Pro odeslání vykonávaných příkazů prostřednictvím USB je využita metoda \texttt{\_stack\_cmd} třídy \texttt{JtagController}, které jsou předávány jednotlivé bajty podle struktury příkazu uvedené tabulce \ref{tab:mpsse_cmd_format}. Takto odeslané příkazy se zapisují do bufferu FTDI převodníku. Vykonání příkazů obsažených v bufferu je spuštěno voláním metody \texttt{sync} třídy \texttt{JtagController}. Tímto je odstartována komunikace na \acs{JTAG} rozhraní a výstupní buffer je vyprázdněn. V případě, že některý z vykonaných příkazů realizoval čtení z \texttt{\acs{TDO}} pinu jsou vyčtená data uložena do vstupního bufferu. \cite{PyFtdi} \cite{PyFtdi_doc}

\subsection{Čtení dat z bufferu FTDI převodníku}
Vyčtení dat přijatých na \texttt{\acs{TDO}} pinu je provedeno voláním metody \texttt{read\_from\_buffer} třídy \texttt{JtagController}. Parametrem funkce je počet bitů, které mají být vyčteny. Do vstupního bufferu jsou data zapisována po bajtech na základě vykonání jednotlivých příkazů, a to i v případě příkazu přijímání dat po bitech. \cite{PyFtdi} \cite{PyFtdi_doc}

Uvedený příklad demonstruje správné vyčtení z bufferu:
\begin{enumerate}[leftmargin = 2cm]
	\item Zápis příkazu: \textit{cmd} = \texttt{0x2A}, \textit{length} = 4 (čtení po bitech)
	\item Zápis příkazu: \textit{cmd} = \texttt{0x28}, \textit{length} = 2 (čtení po bajtech)
	\item Zápis příkazu: \textit{cmd} = \texttt{0x2A}, \textit{length} = 2 (čtení po bitech)
	\item Volání \texttt{data = read\_from\_buffer(35)}
	\item Správné seřazení jednotlivých bitů
\end{enumerate}

Přestože příkazy v bodech 1 až 3 vyčtou z \texttt{\acs{TDO}} pinu 32 bitů (4 bajty) je zapotřebí přečíst ze vstupního bufferu 35 až 40 bitů (5 bajtů), protože každý příkaz vyčte minimálně jeden bajt. První příkaz realizuje čtení 5ti bitů, které se uloží do vstupního bufferu jako bajt, přičemž čtená data jsou řazena od \acs{MSB}. Druhý příkaz vyčte 3 bajty a uloží je do bufferu. Třetí příkaz vyčte 3 bity a uloží je do dalšího bajtu bufferu a data jsou řazena od \acs{MSB}. V případě, že funkce v bodě 4 má vrátit 35 bitů jsou 3 bity vyčtené třetím příkazem funkcí správně zařazeny na 3 \acs{MSB} návratové hodnoty. V tomto příkladě stačí pro správný výsledek (32-bitové číslo) pouze vynechat 3 \acs{LSB} návratové hodnoty funkce. Za použití tohoto přístupu byly vyčteny všechny bajty ze vstupního bufferu a nemůže tak při dalším čtení dojít k vyčtení neplatných dat.

\subsection{Realizace volby vhodné délky přenášených dat}
Z programu vykonávaného za pomoci testovacího softwaru v PC je možné přistupovat k celým registrům nebo jejich částem pomocí operátoru přiřazení, např.: \texttt{SPI0.Control = 5} nebo v případě přístupu k části registru \texttt{SPI0.Control\_f.mode = 3}. Pro čtení lze použít obdobný zápis opačně. V případě přístupu k celému registru je automaticky zvolena délka přenášených dat celého 32-bitového slova.

Pokud jde o přístup k bitovému poli registru je informace o pozici a délce bitového pole získána z \acs{SVD} (\textit{\acl{SVD}}) souboru. Podle této délky a pozice realizované SW rozšíření určí pozici počátečního a koncového bitu v registru. Podle pozic těchto bitů je určena optimální délka dat přenášených přes \acs{JTAG} rozhraní. Možné hraniční případy variant bitových polí a zvolená délka přenosu jsou naznačeny na obrázku \ref{fig:bit_fields}. V případě, že bitové pole se nachází na rozhraní 15 a 16 bitu v registru, musí být pro přenos zvolena délka celého registru (\textit{Word}) i přesto, že délka bitového pole je menší než 16 bitů (\textit{Half-Word}). Tato vlastnost vychází z toho, že systémová sběrnice nepodporuje nezarovnaný přístup k bitům 8 až 23. Pokud je požadován přístup k bitovému poli na rozhraní 8 a 7 nebo 23 a 24 bitu, je zvolen přenos 16 bitů (\textit{Half-Word}) pokud bitové pole nepřesahuje tuto délku. \cite{ri5cy}

\begin{figure}[H]
  \begin{center}
    \includegraphics[scale=0.72]{obrazky/bit_fields.pdf}
  \end{center}
  \caption{Možné varianty délky přenášených dat podle bitového pole}
	\label{fig:bit_fields}
\end{figure}

\subsubsection{Zápis do bitového pole}
Zápisem do bitového pole nesmí být přepsána hodnota ostatních bitů registru dle zvolené délku přenášených dat. Z tohoto důvodu je nejdříve provedeno čtení a jsou přepsány pouze bity daného bitového pole. Výsledná hodnota je zapsána zpět do registru. Další optimalizací je vynechání čtení pokud bitové pole odpovídá některému z možných přístupů na systémovou sběrnici, viz. řádky 1, 3 a 5 v obrázku \ref{fig:bit_fields}. 


%\begin{table}[!h]
%  \caption{Formát příkazů \acs{MPSSE} \cite{MPSSE_cmd}}
%  \begin{center}
%  	\small
%	  \begin{tabular}{!{\vrule width 1.2pt}M{0.2cm}|M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}|M{0.2cm}:M{0.2cm}|M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}|M{0.2cm}:M{0.2cm}|M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}|M{0.2cm}:M{0.2cm}|M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}M{0.2cm}|M{0.2cm}!{\vrule width 1.2pt}}
%	    \noalign{\hrule height 1.2pt}
%	    31 & & & & & & & 24 & 23 & & & & & & & 16 & 15 & & & & & & & 8 & 7 & & & & & & & 0\\
%	    \noalign{\hrule height 1.2pt}
%			\multicolumn{32}{|c|}{word}\\
%			\hline
%		
%			%\multicolumn{7}{M{0.25cm}}{} & & \multicolumn{7}{c|}{} & \multicolumn{2}{|c|}{word} & \multicolumn{6}{|c}{} & & \multicolumn{7}{c}{}\\
%			%\hline
%			%\multicolumn{16}{|M{4cm}|}{half-word} & \multicolumn{16}{|M{4cm}|}{half-word}\\
%			%\hline
%			%\multicolumn{6}{M{1.5cm}|}{} & \multicolumn{2}{|M{0.5cm}|}{half-word} & \multicolumn{6}{|M{1.5cm}}{} & & \multicolumn{7}{M{1.75cm}|}{} & & \multicolumn{2}{|M{0.5cm}|}{half-word} & \multicolumn{6}{|M{1.5cm}}{}\\
%		\end{tabular}
%  \end{center}
%	\label{tab:bit_fields}
%\end{table}
%Každá část registru nese informaci